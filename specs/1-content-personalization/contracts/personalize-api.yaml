openapi: 3.0.3
info:
  title: Content Personalization API
  description: API for personalizing textbook chapters based on user profile
  version: 1.0.0
  contact:
    name: Physical AI Textbook Team

servers:
  - url: http://localhost:8000
    description: Local development
  - url: https://api.physical-ai.vercel.app
    description: Production

security:
  - bearerAuth: []

paths:
  /api/personalize:
    post:
      summary: Personalize chapter content
      description: |
        Transform textbook chapter based on authenticated user's onboarding profile.
        Returns personalized markdown content with transformations applied for:
        - Programming experience level (beginner/intermediate/advanced)
        - Robotics background (none/simulation/hardware)
        - Hardware availability (specific deployment guides)

        **Caching**: Personalized content is cached. Subsequent requests return instantly with cached:true.

        **Rate Limit**: 10 requests per minute per user

        **Fallback**: If LLM service unavailable, returns original content with warning
      operationId: personalizeChapter
      tags:
        - Personalization
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - chapter_id
              properties:
                chapter_id:
                  type: string
                  description: Chapter identifier
                  example: "chapter-01"
                  pattern: '^chapter-\d{2}$'
            examples:
              basic:
                summary: Basic personalization request
                value:
                  chapter_id: "chapter-01"
              advanced:
                summary: Advanced chapter
                value:
                  chapter_id: "chapter-06"

      responses:
        '200':
          description: Successfully personalized content
          content:
            application/json:
              schema:
                type: object
                required:
                  - original_chapter_id
                  - personalized_variant_id
                  - content
                  - applied_transformations
                  - cached
                  - metadata
                properties:
                  original_chapter_id:
                    type: string
                    description: Original chapter identifier
                    example: "chapter-01"
                  personalized_variant_id:
                    type: string
                    description: Unique identifier for this personalized version
                    example: "chapter-01-user-123-v1-a7f3e2"
                  content:
                    type: string
                    description: Personalized markdown content
                    example: "# Fundamentals of Physical AI\\n\\nThis chapter introduces..."
                  applied_transformations:
                    type: array
                    description: List of transformations applied
                    items:
                      type: string
                    example: ["beginner-simplify", "add-examples", "simulator-alternatives"]
                  cached:
                    type: boolean
                    description: Whether content was served from cache
                    example: false
                  metadata:
                    type: object
                    properties:
                      processing_time_ms:
                        type: integer
                        description: Time taken to generate/retrieve (milliseconds)
                        example: 2350
                      profile_hash:
                        type: string
                        description: MD5 hash of user profile used for caching
                        example: "a7f3e2b1c4d5e6f7"
                      llm_provider:
                        type: string
                        description: LLM service used for transformation
                        example: "claude"
                        enum: [claude, openai]
                      fallback_used:
                        type: boolean
                        description: Whether fallback to original content was used
                        example: false
              examples:
                success_uncached:
                  summary: First request (uncached)
                  value:
                    original_chapter_id: "chapter-01"
                    personalized_variant_id: "chapter-01-user-123-v1-a7f3e2"
                    content: "# Fundamentals of Physical AI (Simplified)\\n\\n**For Beginners**: This chapter..."
                    applied_transformations: ["beginner-simplify", "add-visual-aids"]
                    cached: false
                    metadata:
                      processing_time_ms: 2350
                      profile_hash: "a7f3e2b1c4d5e6f7"
                      llm_provider: "claude"
                      fallback_used: false

                success_cached:
                  summary: Subsequent request (cached)
                  value:
                    original_chapter_id: "chapter-01"
                    personalized_variant_id: "chapter-01-user-123-v1-a7f3e2"
                    content: "# Fundamentals of Physical AI (Simplified)..."
                    applied_transformations: ["beginner-simplify", "add-visual-aids"]
                    cached: true
                    metadata:
                      processing_time_ms: 45
                      profile_hash: "a7f3e2b1c4d5e6f7"
                      llm_provider: null
                      fallback_used: false

        '401':
          description: Unauthorized - invalid or missing JWT token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Unauthorized"
                message: "Valid authentication token required"
                code: "AUTH_REQUIRED"

        '404':
          description: Chapter not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Not Found"
                message: "Chapter 'chapter-99' does not exist"
                code: "CHAPTER_NOT_FOUND"

        '422':
          description: Validation error - invalid chapter_id format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Validation Error"
                message: "chapter_id must match pattern 'chapter-XX'"
                code: "INVALID_INPUT"

        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Too Many Requests"
                message: "Rate limit exceeded: 10 requests per minute"
                code: "RATE_LIMIT_EXCEEDED"
                retry_after: 45

        '500':
          description: LLM service unavailable (returns original content with warning)
          content:
            application/json:
              schema:
                type: object
                properties:
                  original_chapter_id:
                    type: string
                  personalized_variant_id:
                    type: string
                  content:
                    type: string
                    description: Original chapter content (fallback)
                  applied_transformations:
                    type: array
                    items:
                      type: string
                    example: []
                  cached:
                    type: boolean
                    example: false
                  metadata:
                    type: object
                    properties:
                      fallback_used:
                        type: boolean
                        example: true
                      fallback_reason:
                        type: string
                        example: "LLM service timeout"
                  warning:
                    type: string
                    example: "Personalization temporarily unavailable. Showing original content."

  /api/personalize/cache-stats:
    get:
      summary: Get cache statistics for current user
      description: Returns caching metrics for debugging and analytics
      operationId: getCacheStats
      tags:
        - Personalization
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Cache statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_cached:
                    type: integer
                    description: Number of chapters cached for this user
                    example: 5
                  hit_rate:
                    type: number
                    format: float
                    description: Cache hit rate percentage (0-100)
                    example: 75.5
                  chapters_cached:
                    type: array
                    description: List of cached chapter IDs
                    items:
                      type: string
                    example: ["chapter-01", "chapter-02", "chapter-06"]
                  total_size_kb:
                    type: integer
                    description: Total storage used by user's cache (KB)
                    example: 150
                  last_updated:
                    type: string
                    format: date-time
                    description: Timestamp of most recent cache entry
                    example: "2025-12-12T10:30:00Z"

        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login

  schemas:
    Error:
      type: object
      required:
        - error
        - message
        - code
      properties:
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Machine-readable error code
        retry_after:
          type: integer
          description: Seconds until retry allowed (for 429 errors)

tags:
  - name: Personalization
    description: Content personalization endpoints
