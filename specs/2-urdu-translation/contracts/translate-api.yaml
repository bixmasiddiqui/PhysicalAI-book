openapi: 3.0.3
info:
  title: Translation API
  description: On-demand Urdu translation for Physical AI textbook chapters
  version: 1.0.0
  contact:
    name: Backend Team
    email: support@physical-ai-textbook.com

servers:
  - url: http://localhost:8000/api
    description: Local development
  - url: https://api.physical-ai-textbook.com/api
    description: Production

tags:
  - name: Translation
    description: Chapter translation endpoints

paths:
  /translate:
    post:
      summary: Translate chapter to target language
      description: |
        Translates a textbook chapter to the specified target language (default: Urdu).
        Uses LLM-based translation with technical term preservation.
        Results are cached globally for all users.
      operationId: translateChapter
      tags:
        - Translation
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TranslateRequest'
            examples:
              basic:
                summary: Translate chapter to Urdu
                value:
                  chapter_id: "chapter-01"
                  target_language: "urdu"
              with_custom_content:
                summary: Translate personalized variant
                value:
                  chapter_id: "chapter-01"
                  target_language: "urdu"
                  source_content: "# Personalized Chapter Content..."
      responses:
        '200':
          description: Translation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranslateResponse'
              examples:
                fresh_translation:
                  summary: Fresh translation (cache miss)
                  value:
                    original_chapter_id: "chapter-01"
                    target_language: "urdu"
                    translated_content: "# فزیکل AI اور روبوٹکس...\n\nیہ باب روبوٹکس کی بنیادی باتیں بیان کرتا ہے۔"
                    cached: false
                    metadata:
                      processing_time_ms: 3250
                      content_hash: "a3c5f1b2"
                      llm_provider: "claude"
                      tokens_used: 4200
                      fallback_used: false
                cached_translation:
                  summary: Cached translation (cache hit)
                  value:
                    original_chapter_id: "chapter-01"
                    target_language: "urdu"
                    translated_content: "# فزیکل AI اور روبوٹکس...\n\nیہ باب روبوٹکس کی بنیادی باتیں بیان کرتا ہے۔"
                    cached: true
                    metadata:
                      processing_time_ms: 45
                      content_hash: "a3c5f1b2"
                      llm_provider: null
                      tokens_used: 0
                      fallback_used: false
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_language:
                  value:
                    detail: "Unsupported target language. Supported: urdu"
                missing_chapter:
                  value:
                    detail: "chapter_id is required"
        '401':
          description: Unauthorized (missing or invalid JWT)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: "Not authenticated"
        '404':
          description: Chapter not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: "Chapter chapter-99 not found"
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: "Rate limit exceeded. Maximum 20 translations per hour."
        '500':
          description: Translation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                llm_error:
                  value:
                    detail: "Translation failed: LLM API unavailable"
                fallback:
                  value:
                    original_chapter_id: "chapter-01"
                    target_language: "urdu"
                    translated_content: "# Original English content (fallback)..."
                    cached: false
                    metadata:
                      processing_time_ms: 150
                      fallback_used: true
                      fallback_reason: "Claude API timeout"

  /translate/cache-stats:
    get:
      summary: Get translation cache statistics
      description: Returns cache metrics for the authenticated user's translations
      operationId: getTranslationCacheStats
      tags:
        - Translation
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Cache statistics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CacheStatsResponse'
              example:
                total_cached: 15
                languages:
                  - language: "urdu"
                    count: 15
                chapters_cached:
                  - "chapter-01"
                  - "chapter-02"
                  - "chapter-03"
                hit_rate: 78.5
                total_size_kb: 425.3
                last_updated: "2025-12-13T14:30:00Z"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /translate/cache/{chapter_id}:
    delete:
      summary: Invalidate translation cache for a chapter
      description: |
        Clears all cached translations for the specified chapter.
        Used when original chapter content is updated.
        Requires admin privileges (future implementation).
      operationId: invalidateTranslationCache
      tags:
        - Translation
      security:
        - BearerAuth: []
      parameters:
        - name: chapter_id
          in: path
          required: true
          description: ID of the chapter to invalidate cache for
          schema:
            type: string
            example: "chapter-01"
      responses:
        '200':
          description: Cache invalidated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Cache invalidated for chapter-01"
                  deleted_count:
                    type: integer
                    example: 3
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (admin only)
        '404':
          description: Chapter not found in cache

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from /auth/login or /auth/signup

  schemas:
    TranslateRequest:
      type: object
      required:
        - chapter_id
      properties:
        chapter_id:
          type: string
          description: ID of the chapter to translate
          example: "chapter-01"
          pattern: '^chapter-\d{2}$'
        target_language:
          type: string
          description: Target language code (currently only 'urdu' supported)
          enum: [urdu]
          default: "urdu"
        source_content:
          type: string
          description: |
            Optional: Custom content to translate (e.g., personalized variant).
            If not provided, loads original chapter from docs/
          nullable: true
          example: "# Custom Chapter Content\n\nThis is personalized content..."

    TranslateResponse:
      type: object
      required:
        - original_chapter_id
        - target_language
        - translated_content
        - cached
        - metadata
      properties:
        original_chapter_id:
          type: string
          description: ID of the original chapter
          example: "chapter-01"
        target_language:
          type: string
          description: Language the content was translated to
          example: "urdu"
        translated_content:
          type: string
          description: Translated chapter content in markdown format
          example: "# فزیکل AI اور روبوٹکس\n\nیہ باب..."
        cached:
          type: boolean
          description: Whether the response was served from cache
          example: false
        metadata:
          type: object
          description: Translation metadata and performance metrics
          properties:
            processing_time_ms:
              type: integer
              description: Total processing time in milliseconds
              example: 3250
            content_hash:
              type: string
              description: MD5 hash of source content (for cache invalidation)
              example: "a3c5f1b2"
            llm_provider:
              type: string
              nullable: true
              description: LLM provider used (null if cached)
              enum: [claude, openai, null]
              example: "claude"
            tokens_used:
              type: integer
              description: Number of tokens consumed (0 if cached)
              example: 4200
            fallback_used:
              type: boolean
              description: Whether fallback to original content was triggered
              example: false
            fallback_reason:
              type: string
              nullable: true
              description: Reason for fallback (if applicable)
              example: "LLM API timeout"

    CacheStatsResponse:
      type: object
      required:
        - total_cached
        - languages
        - chapters_cached
        - hit_rate
        - total_size_kb
      properties:
        total_cached:
          type: integer
          description: Total number of cached translations
          example: 15
        languages:
          type: array
          description: Breakdown by language
          items:
            type: object
            properties:
              language:
                type: string
                example: "urdu"
              count:
                type: integer
                example: 15
        chapters_cached:
          type: array
          description: List of chapter IDs with cached translations
          items:
            type: string
          example: ["chapter-01", "chapter-02", "chapter-03"]
        hit_rate:
          type: number
          format: float
          description: Cache hit rate percentage
          example: 78.5
        total_size_kb:
          type: number
          format: float
          description: Total cache size in kilobytes
          example: 425.3
        last_updated:
          type: string
          format: date-time
          description: Timestamp of most recent cache entry
          example: "2025-12-13T14:30:00Z"

    Error:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Human-readable error message
          example: "Translation failed: Invalid API key"
        error_code:
          type: string
          description: Machine-readable error code (optional)
          example: "TRANSLATION_FAILED"

  examples:
    GlossaryTermsPreserved:
      summary: Technical terms preserved in translation
      description: |
        Example showing that technical terms from the glossary remain in English:
        - ROS, URDF, Gazebo (robotics terms)
        - Python, C++, API (programming terms)
        - ZMP, DOF, FK, IK (math/kinematics terms)
      value:
        original: "In ROS, we use URDF files to define robot kinematics. Python and C++ APIs are available."
        translated: "ROS میں، ہم URDF فائلوں کو استعمال کرتے ہیں روبوٹ kinematics کی تعریف کے لیے۔ Python اور C++ APIs دستیاب ہیں۔"

    CodeBlockPreserved:
      summary: Code blocks remain untranslated
      description: |
        Example showing that code blocks are preserved entirely in English
      value:
        original: |
          Here's a simple Python script:
          ```python
          import rospy
          rospy.init_node('my_node')
          ```
        translated: |
          یہاں ایک سادہ Python script ہے:
          ```python
          import rospy
          rospy.init_node('my_node')
          ```
